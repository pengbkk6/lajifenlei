# 一，技术选型和效果图
## 1，技术选型
### 1-1，前端
- 小程序原生框架
- css
- JavaScript
### 1-2，管理后台
- 云开发Cms内容管理系统
- web网页
- 百度开发者控制台
### 1-3，数据后台
- 小程序云开发
- 云函数
- 云数据库
- 云存储
- 百度人工智能图片识别
- 百度人工智能语音识别

## 2，效果图预览
### 2-1，首页
![](https://img-blog.csdnimg.cn/8587ea06e9cd4b09aca35fc296463139.png)
### 2-2，新闻
新闻分类
![](https://img-blog.csdnimg.cn/1c6d733b44d84b56b9c03424005d4c50.png)
新闻详情和收藏
![](https://img-blog.csdnimg.cn/d3f5a90f3c1f4741a15308c99b34f680.png)
新闻评论和热门推荐
![](https://img-blog.csdnimg.cn/3e5c1bbe64a94a87b348e576b68b2071.png)
评论文章
![](https://img-blog.csdnimg.cn/18eb69a322a441ddb4e425be88987365.png)
### 2-3，图片识别
拍照识别，
![](https://img-blog.csdnimg.cn/d4ba6303d0f34a2eb28b9431d622c31e.png)
比如我拍一个评估识别结果
![](https://img-blog.csdnimg.cn/735e0bffa2c84283bd38d0691f097b53.png)
查看识别的图片属于什么垃圾
![](https://img-blog.csdnimg.cn/8dcfe9e68cc545eca2b990cc28eae517.png)
### 2-4，语音识别
长按识别，并查看识别结果
![](https://img-blog.csdnimg.cn/5abdee6bbd0b48f38200099091c89f67.png)
查看识别的文字属于什么垃圾
![](https://img-blog.csdnimg.cn/148891aaca1f41809539ff1ae70e3edb.png)
### 2-5，视频
视频列表

![](https://img-blog.csdnimg.cn/fbe661804c3045ee89f1d9714c9d4f2f.png)
视频详情
![](https://img-blog.csdnimg.cn/cb48378b9cda4fa083d9fb0ffd74b435.png)
### 2-6，搜索功能
搜索垃圾
![](https://img-blog.csdnimg.cn/319ee8588b0641d88e73b780692e1373.png)
搜索文章
![](https://img-blog.csdnimg.cn/22c1d8ee5f2049b294b7c6c59a8ee529.png)
### 2-7，垃圾分类列表
四种垃圾分类介绍
![](https://img-blog.csdnimg.cn/b0fb2aecb7ae4fd590a1706b77d803eb.png)
每种分类包含那些垃圾
![](https://img-blog.csdnimg.cn/89f4a183f52f49bd8ded1917dcdd980b.png)
### 2-8，答题竞赛
每日答题
![](https://img-blog.csdnimg.cn/bc71bcb4121e446ea1fe6f1abe2ad3b5.png)
注册用户参加排名
![](https://img-blog.csdnimg.cn/37f9a3bb73f9410c835841b32cee591d.png)
积分排名
![](https://img-blog.csdnimg.cn/f6559081d8d945248acb828fba64daf6.png)
错题集
![](https://img-blog.csdnimg.cn/ae2d403f3ebb44148442d40c3698f629.png)
正确率分析
![](https://img-blog.csdnimg.cn/9d58148852d54403a57b23de5d45c6f6.png)
### 2-9，个人中心
未登录
![](https://img-blog.csdnimg.cn/ce7a3e193c8e46f9961b07d6fcba50cb.png)
已登陆
![](https://img-blog.csdnimg.cn/c91c2358879b4c3bbb627b2d648fae79.png)
我的收藏
![](https://img-blog.csdnimg.cn/0a54260c65594da698b3cb3a6be574b9.png)
### 2-8，在线客服
客户直接在小程序里发消息给客服
![](https://img-blog.csdnimg.cn/20210215150533164.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FpdXNoaV8xOTkw,size_16,color_FFFFFF,t_70)
客服可以在网页端，或者微信端管理消息
![](https://img-blog.csdnimg.cn/20210215150628552.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FpdXNoaV8xOTkw,size_16,color_FFFFFF,t_70)
网页端客服
![](https://img-blog.csdnimg.cn/20210215150649875.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FpdXNoaV8xOTkw,size_16,color_FFFFFF,t_70)
小程序端客服
![](https://img-blog.csdnimg.cn/20210215150709948.png)
### 2-9，意见反馈
客户可以直接在小程序端提建议，建议里可以添加图片
![](https://img-blog.csdnimg.cn/20210215150753867.png)
管理员可以在小程序后台，查看客户的反馈
![](https://img-blog.csdnimg.cn/20210215150857836.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FpdXNoaV8xOTkw,size_16,color_FFFFFF,t_70)
### 2-10上面回收商
![](https://img-blog.csdnimg.cn/2c3d240a5704410db9c9eba3761c0c4b.png)

## 3，cms管理后台
我们这里的可视化网页后台使用的时云开发自带的cms(内容管理)
### 3-1，登录页
![](https://img-blog.csdnimg.cn/20210215151020437.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FpdXNoaV8xOTkw,size_16,color_FFFFFF,t_70)
### 3-2，管理后台
![](https://img-blog.csdnimg.cn/c5e66089c036481c8b90167166362f23.png)

我们可以在这里
- 1，添加新闻，删除新闻，修改新闻
- 2，添加垃圾，删除垃圾，修改垃圾
- 3，添加视频，删除视频，修改视频
- 4，添加题库，删除题库，修改题库
- 5，查看文章评论
- 6，添加回收商，删除回收商，修改回收商

还有更多的功能，我会在视频课里给大家用视频来演示，这样更直观。

## 4，数据库
数据库我们这里用云开发自带的云数据库，下面的集合就是我们的数据表。
![](https://img-blog.csdnimg.cn/a34c676cbb8f475d951b26be4a644c2d.png)

# 二~微信开发者工具的安装与使用

> 我们在开发小程序之前，首先需要安装小程序开发者工具，今天就来教大家安装小程序开发者工具。

## 2-1，其实很简单，只需要进入小程序官网，然后点击工具，如下图所示。
https://developers.weixin.qq.com/miniprogram/dev/devtools/devtools.html
![](https://img-blog.csdnimg.cn/img_convert/20682b84a9b87759db822751e0d694c6.png)
![](https://img-blog.csdnimg.cn/img_convert/71d862f489ebac0076a391c6310322b2.png)
当然了，也可以直接通过下面链接去下载
[https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html](https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html)

## 2-2，下载安装包如下

![](https://img-blog.csdnimg.cn/img_convert/c61ed94c18d4476426097fe428fb924c.png)
不管你是window还是mac电脑，只需要双击安装包实现安装即可。
![](https://img-blog.csdnimg.cn/img_convert/c5e8f3589086565f79faa7305c3f74f4.png)
等待安装即可
![](https://img-blog.csdnimg.cn/img_convert/ec63fb1c56f8be922a8d9181b2527d76.png)
安装完成
![](https://img-blog.csdnimg.cn/img_convert/55d199b06043a3c5ecd22bcd28643784.png)

## 2-3，进入开发者工具

第一次进入时，如下
![](https://img-blog.csdnimg.cn/img_convert/cbd6178708ad85de0ec3c01e2bf3b1c3.png)
点击上图的加号，就可以创建一个新项目，我们主要教大家如何导入项目，视频里会有详细讲解。


# 三，注册小程序

我们前面虽然可以用测试号创建小程序,但是测试号有很多功能会受限,比如我们后面讲的云开发,必须是注册小程序后才可以使用,所以今天我们就来讲讲小程序的注册.

## 3-1，其实官方给的注册步骤很详细了

![](https://img-blog.csdnimg.cn/img_convert/9620803e90a57d6ce600cdb5cafced2f.png)
官方注册地址:[https://mp.weixin.qq.com/wxopen/waregister?action=step1](https://mp.weixin.qq.com/wxopen/waregister?action=step1)
进入注册页面时,跟着提示一步步来就可以了
![](https://img-blog.csdnimg.cn/img_convert/b4e63808210224e80f8a5ecec6d9bc6a.png)

## 3-2，注意点:

如果只是学习的话,注册个人小程序即可.
如果想商用,想使用微信支付,取用户手机号等复杂功能,可以注册企业小程序,不过企业小程序必须有营业执照才可以注册.

# 四，云开发环境的创建

今天我们就来正式的创建自己的第一个云开发项目,在创建云开发之前,有下面几个注意事项

- 1,必须注册小程序后才可以开通云开发
- 2,一个小程序可以创建两个云开发环境，学习的时候最好只创建一个

## 4-1,创建一个云开发项目

![](https://img-blog.csdnimg.cn/img_convert/b3e24e88eb27a664900db49daa66a684.png)
和创建普通小程序一样,如上图所示,需要注意的就是这里必须要填写自己的appid,不可以用测试号. appid的获取如下图所示.
![](https://img-blog.csdnimg.cn/img_convert/43386c9a0bb79a29ecf3a9bfd6ecc436.png)

## 4-2,开通云开发

- 1,点击下图箭头所示,如果你第一步创建项目时,没有使用自己的appid,这里不会有下图箭头所示的云朵.
  ![](https://img-blog.csdnimg.cn/img_convert/f28c71198f399293ebd266a1f2211c1c.png)

- 2,给云开发环境取名
  ![](https://img-blog.csdnimg.cn/img_convert/023a13f0eaa1e9c6db839570adc791c5.png)

  等待创建
  ![](https://img-blog.csdnimg.cn/img_convert/4e0a7c2e116e9bf6d5154140351e7a48.png)
  创建成功
  ![](https://img-blog.csdnimg.cn/img_convert/3fb52c3abacfbcb4f7b1f877f485f96c.png)

- 3,获取云开发环境id
  ![](https://img-blog.csdnimg.cn/img_convert/c37ed1928a12e773d4782e2f3fee97c2.png)

## 4-3,初始化云开发环境

在app.js里写入环境id,注意这里要用你自己的云开发环境id

```
 wx.cloud.init({
        env: "xiaoshitou-xs7fr"
 })
```

![](https://img-blog.csdnimg.cn/img_convert/9f837da57ccadc065f94f7f9ebed5ad8.png)
用时候云开发创建好以后,初始化可能需要一点时间,所以如果这里初始化有报错,记得关闭开发者工具,等几分钟再重新打开即可.
# 五，开通cms内容管理
## 5-1，开通cms的准备工作
如下图所示，直接点击开通内容管理(CMS)即可
![](https://img-blog.csdnimg.cn/20210210113912477.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FpdXNoaV8xOTkw,size_16,color_FFFFFF,t_70)
开通cms需要你云开发里使用按量付费，如果你是第一次开通云开发，记得做如下选择。
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210310190751658.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FpdXNoaV8xOTkw,size_16,color_FFFFFF,t_70)
如果你已经开通过云开发，记得把付费模式改为按量付费。如果你一开始云开发不是按量付费的模式。

点击完开通以后，会有如下弹窗，直接点击确定即可。不要被付费吓着，官方每月会送我们一定的免费额度的。学习得话基本上够用了。
![](https://img-blog.csdnimg.cn/20210210114114135.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FpdXNoaV8xOTkw,size_16,color_FFFFFF,t_70)
上面点完确定后，我们只是开启了按量付费功能，因为cms得使用必须要开通按量付费才可以得。所以还要再点一次开通。如下图
![](https://img-blog.csdnimg.cn/20210210114330998.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FpdXNoaV8xOTkw,size_16,color_FFFFFF,t_70)
点完开通后，会有如下弹窗，直接点击下一步即可。
![](https://img-blog.csdnimg.cn/20210210114443541.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FpdXNoaV8xOTkw,size_16,color_FFFFFF,t_70)
然后我们需要设置登录内容管理后台得账号和密码，然后点击确定即可
![](https://img-blog.csdnimg.cn/20210210114541730.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FpdXNoaV8xOTkw,size_16,color_FFFFFF,t_70)
然后我们就等待内容管理功能得开通了，需要等几分钟。
![](https://img-blog.csdnimg.cn/20210210114640668.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FpdXNoaV8xOTkw,size_16,color_FFFFFF,t_70)
开通成功以后，我们就可以通过下面这个地址进入管理后台了。
![](https://img-blog.csdnimg.cn/20210210133616295.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FpdXNoaV8xOTkw,size_16,color_FFFFFF,t_70)
后面我们统一称内容管理为cms
## 5-2，注意事项
- 一个云开发环境对应一个内容管理(cms)
- cms开通会存在开通失败的情况，如果开通失败了，就用新的云开发环境去开通，如果新的云开发环境还是不行的话，那就只能重新去注册一个新的小程序了。一个小程序是可以开通两个云开发环境的。
-  现在小程序官方改规则了，使用内容模型，每月可能要付几毛钱。不过学习使用的话，不会用太多的。一个月几元钱足够了。

## 5-3，登录Cms可视化管理后台
上面开通好以后，就可以通过后台地址登录管理后台了。如下
![](https://img-blog.csdnimg.cn/20210210133522942.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FpdXNoaV8xOTkw,size_16,color_FFFFFF,t_70)
## 5-4，在cms里创建后台项目
第一次登录，我们还需要创建一个项目
![](https://img-blog.csdnimg.cn/20210210133725671.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FpdXNoaV8xOTkw,size_16,color_FFFFFF,t_70)
自己输入项目名和项目id即可
![](https://img-blog.csdnimg.cn/20210210133904722.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FpdXNoaV8xOTkw,size_16,color_FFFFFF,t_70)
然后点击进入刚刚创建的项目
![](https://img-blog.csdnimg.cn/9f7b0fb259104355954fa44c817029c7.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA57yW56iL5bCP55-z5aS0,size_20,color_FFFFFF,t_70,g_se,x_16)

到这里我们的cmd可视化网页管理后台就创建好了


## 5-5，内容模型
![](https://img-blog.csdnimg.cn/8382630149d541af89e4512c57914ce9.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA57yW56iL5bCP55-z5aS0,size_20,color_FFFFFF,t_70,g_se,x_16)
我会在视频里教大家如何创建内容模型，其实内容模型和我们数据库里的数据表(集合)是对应起来的。
## 5-6，导入内容模型（一定要导入）
我们在cms后台，点击导入模型
![](https://img-blog.csdnimg.cn/668706941e6e40a59aa40396d337a175.png)
然后把我源码数据目录下的内容模型拖入即可导入，这里的内容模型其实就是我们的数据表。
![](https://img-blog.csdnimg.cn/78c4be49c818409eae19ed8b0c3a5948.png)
## 5-9，导入数据
我把新闻，垃圾分类，题库这三个表的数据，提前给大家准备好了，大家在cms网页点击导入即可。
![](https://img-blog.csdnimg.cn/bbeae6bc16024ba490824c8bd141a3c1.png)
通过json导入
![](https://img-blog.csdnimg.cn/a6f9342d82074e9ea6d06e6d1b032b59.png)

## 5-8，修改表权限
我们下面5个表要改下表权限 huishou，news ，questions，refuse，video 权限改为所有用户可读，仅创建者读写。
![](https://img-blog.csdnimg.cn/c8b4fdf7f2184dc9ae3918c00a6d94ea.png)


# 六，垃圾分类小程序的部署

今天我们来讲下垃圾分类小程序的部署，部署中一些细节的问题也会给大家讲解下。
##  6-1，下载源码
如果有买我课，或者办我的年卡，都可以获取到源码。
## 6-2，打开开发者工具导入源码

![](https://img-blog.csdnimg.cn/img_convert/ca4536b6bdd4adf523f7464d9e1c3ecb.png)
源码的导入我在小程序基础课里有讲的。这门课的详情讲解里也会教大家如何导入源码的。

## 6-3，云开发环境的初始化
云开发的开通，在我云开发基础入门里也有讲，这里就不在累述。
创建好云开发后，要在app.js里进行云开发环境的初始化。
![](https://img-blog.csdnimg.cn/img_convert/d64f9d7a7623f8e4dfb47dc11c998378.png)


## 6-4，部署云函数（一定要部署）
先选择云开发环境
![](https://img-blog.csdnimg.cn/20210519103244527.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FpdXNoaV8xOTkw,size_16,color_FFFFFF,t_70)
如下图所示，部署云函数。
![](https://img-blog.csdnimg.cn/img_convert/2544d291d1738a555c1906e635e802cd.png)
下面几个云函数都要部署，部署成功后文件前面会出现一个云朵的标识。
![](https://img-blog.csdnimg.cn/8ecd1c48d9a14e58898601f65b56ab9f.png)


# 七，图片和语音识别准备工作
## 7-1，注册百度开发者账号
我们这里使用了百度的图片识别技术，所以在使用之前我们要现在注册百度开发者账号，官方地址：[https://ai.baidu.com](https://ai.baidu.com)
注册地址：[https://login.bce.baidu.com](https://login.bce.baidu.com)
至于如何注册，这里不需要我再教了吧，大家自行注册就行了。

我们主要用到的是图片识别和语音识别技术
![](https://img-blog.csdnimg.cn/a50a1723a6c4485b8b2228a970d43033.png)
## 7-2，注册完记得要实名下
现在使用百度图片识别，必须要实名认证下。
![](https://img-blog.csdnimg.cn/7f5f3c4dba104cfabe27897e3c67a27a.png)
根据自己的情况选择认证方式
![](https://img-blog.csdnimg.cn/fbb6b3a09f664307893465a8fc58294e.png)
学习的话，只需要个人认证即可。
![](https://img-blog.csdnimg.cn/e1a5b88a94a24306adbc5ab47077dca7.png)
## 7-3，创建图片和语音识别应用
我们要使用图片识别和语音识别功能，就要创建一个应用 。

我们可以在图像识别下创建应用，记得勾选图片识别和语音技术就行。![](https://img-blog.csdnimg.cn/904a7e8300e146e2837352c100009b1e.png)
点击完创建应用后，把图像识别和语音技术全部勾选。
![](https://img-blog.csdnimg.cn/f62c980464eb40168f5f23f0a75ebd27.png)

当然了，如果你一开始考虑清楚都用那些功能以后，可以把你想要的功能都勾选了，这样以后就不用重复的创建应用了。
![](https://img-blog.csdnimg.cn/9511d94f7f7944b685db344036ef4235.png)
选个人即可
![](https://img-blog.csdnimg.cn/279dd7bc95fe4e5dabd0fc7f5de06544.png)
这样我们就创建好应用了
![](https://img-blog.csdnimg.cn/e2deb0616b214c4e8788bc2573dfac7e.png)
创建好以后，下面两个东西我们后面会用到，知道在哪里即可。
![](https://img-blog.csdnimg.cn/c40435fa6b2543d8bb45fd67504c4a90.png)
## 7-4，领取免费资源
### 7-4-1，图像识别资源
同样的我们要使用图片识别功能，也是要去领取免费资源的，要不然我们连免费使用的额度都没有，当然啦，如果百度后面改规则了，我们就只能付费购买这些资源了。如果只是学习用的话，用不了几毛钱。
![](https://img-blog.csdnimg.cn/263172ab21304ad4b944bd0c98f82f9a.png)
所以先把能领的都领取下。

估计百度是在为后期收费做准备，但是目前还有免费资源可以领取。既然可以白piao就先领取免费的。即便后期收费了，咱们学习使用估计也用不了太多，几毛钱的估计就够咱们学习用的了。

点击免费领取资源
![](https://img-blog.csdnimg.cn/c8cbe48a323d44bb9d923da62430a579.png)
既然免费，当然全部领取了啊。领取完，耐心等待生效即可。如果你在学习的时候，不能在免费领取了，那就花几毛钱付费下也行的，基本上几毛钱就够咱们学习使用了。
![](https://img-blog.csdnimg.cn/df3de46fab0541f58639cfbb83622a45.png)
领取完图片识别的，语音技术的也要领啊。
### 7-4-2，语音技术资源
![](https://img-blog.csdnimg.cn/547e2d6c15ee46e4a423e39febaafd05.png)
点击免费领取
![](https://img-blog.csdnimg.cn/44c3d01c72cf44448534de70b21a8f1a.png)
把能领的全部领了。
![](https://img-blog.csdnimg.cn/1b6cbbaf8ec14283a85c2f0d18be9cb5.png)
领取完大概30分钟内生效。
![](https://img-blog.csdnimg.cn/fb344b85306943c49fce92ea023da05c.png)
## 7-5，添加百度域名到小程序
我们这里要调用百度的接口，所以需要配置域名到小程序，如果不配置的话，就会报如下错误。
![](https://img-blog.csdnimg.cn/48ce09cf377c417b99a3d0361a88a6ce.png)
![](https://img-blog.csdnimg.cn/6ae77c3d12e747d88c680c176a255c19.png)

所以需要到小程序后台，把https://aip.baidubce.com 和
https://vop.baidu.com添加到如下位置。
![](https://img-blog.csdnimg.cn/5c4eaf15d20a4d339ebf5885de817383.png)
![](https://img-blog.csdnimg.cn/b8a07b7123bd41459d4699681907110b.png)
点击上面的服务设置，然后做如下设置。
![](https://img-blog.csdnimg.cn/0f65e268ff69488ab858aacc1f1ddf3f.png)
一般设置后10分钟左右生效。
![](https://img-blog.csdnimg.cn/56c4a8b9a9f646af8a72757eaff0b1d0.png)

## 7-6，技术文档
语音技术文档：https://cloud.baidu.com/doc/SPEECH/index.html
图片识别文档：https://cloud.baidu.com/doc/IMAGERECOGNITION/index.html

语音识别用的是短语音识别极速版。
![](https://img-blog.csdnimg.cn/aa879825ecfe434d97b448b3bb867376.png)


# 八，图片和语音识别的配置

## 8-1，应用的识别的配置
如下图所示，我们要配置百度识图的apikey和sectetKey
![](https://img-blog.csdnimg.cn/8de1b22c8ac041bb97dfe924d614b595.png)
把上图app.js里的apikey和secretkey换成你自己的。我们笔记的前面7-4章节有教大家如何注册百度应用。这里我视频里也会做讲解，如果有买我课，或者办我的年卡，都可以获取讲解视频。

## 8-2，使用百度的图片识别技术
这个时候直接使用，通常会报下面的错误，如果你跟着笔记里的7-5的域名配置做过配置的话，就只需要耐心的等待几分钟即可，如果没有配置，就会报如下错误。
![](https://img-blog.csdnimg.cn/img_convert/d2e5ac4bb3d6387fc9c20d15ff0ad55e.png)
这个错误是因为我们没有配置安全域名所致。
![](https://img-blog.csdnimg.cn/20210519103538464.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FpdXNoaV8xOTkw,size_16,color_FFFFFF,t_70)
把https://aip.baidubce.com 和
https://vop.baidu.com添加到如下位置
![](https://img-blog.csdnimg.cn/img_convert/9f876a1c262134b08a315d4b2b6bbcdf.png)
配置好以后，记得等待几分钟才会生效，这样我们再次使用时，就可以成功的使用垃圾图片识别功能了。
![](https://img-blog.csdnimg.cn/img_convert/fc2a252121c2cf760e6c9ac7c4a93b32.png)
这样我们就可以愉快的使用垃圾分类小程序的图片识别功能了。
## 8-3，真机测试语音识别
有时候如果是老人使用垃圾分类，打字搜索不太方便，这个时候我们就可以通过语音识别来实现垃圾分类搜索了。
和上面的图片识别一样，我们只需要调用百度的语音识别技术即可

我们直接在电脑模拟器上是无法使用语音识别的，会报如下错误。
![](https://img-blog.csdnimg.cn/3d3d6be54de14c3ea9a6abe48ea55392.png)
到官方文档的错误码里看下这个就知道了：https://cloud.baidu.com/doc/SPEECH/s/pkhq0q4vy
![](https://img-blog.csdnimg.cn/abe7fc80abcb470493be56687b541f5a.png)
解决办法就是电脑模拟器没法识别语音，必须用真机调试。
![](https://img-blog.csdnimg.cn/103dcc3fbec24bef92872e7c6c15dce6.png)
点击真机调试，然后用手机扫码，就可以在手机上查看了。只有用手机才可以识别出语音。
![](https://img-blog.csdnimg.cn/015aec93ee7d473fb8688e6960baa317.png)
效果图：
![](https://img-blog.csdnimg.cn/959ca79934ad44569a93a0f65ab5dc71.png)
点击去搜索：
![](https://img-blog.csdnimg.cn/72dfcd2f06794922bf40c3cf3facb016.png)

## 8-4， 注意事项
如果报下面所示的错误，说明你的免费额度用完了，最好去开通下百度的付费识别功能。
![](https://img-blog.csdnimg.cn/bd7035accc424fb6ae22107fd4a09388.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA57yW56iL5bCP55-z5aS0,size_20,color_FFFFFF,t_70,g_se,x_16)
去官方文档里查询也是说免费额度用完了
![](https://img-blog.csdnimg.cn/2487519490c44171bd71f465552cf11d.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA57yW56iL5bCP55-z5aS0,size_20,color_FFFFFF,t_70,g_se,x_16)
所以要开通付费功能，如下
首先声明，我不是为了推广百度，之前百度确实是有一定的免费额度供大家使用的，既然他们现在不提供免费额度给大家使用了，咱们作为弱势群体也没有办法，要么换别家，但是别家页基本上收费了，要么就省一瓶饮料钱来学习下。

如下图，点击开通即可。这里最好开通按量付费，用多少付多少就行
![](https://img-blog.csdnimg.cn/abf8b828dba44ad59cf71059bd60bc6a.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA57yW56iL5bCP55-z5aS0,size_20,color_FFFFFF,t_70,g_se,x_16)
可以看出，我们花几元钱就可以调用上千次，学习的话这几千次基本上够用了。
![](https://img-blog.csdnimg.cn/b4e91c6d32e743d6aa81caa7830fd7a4.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA57yW56iL5bCP55-z5aS0,size_20,color_FFFFFF,t_70,g_se,x_16)
但是开通之前还要实名认证下。
![](https://img-blog.csdnimg.cn/ff2d16ae6c6a4d95b852ff8d401a8da8.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA57yW56iL5bCP55-z5aS0,size_20,color_FFFFFF,t_70,g_se,x_16)
这里我就不在啰嗦，自己实名认证完即可回来开通就行。

实名认证完，记得去充点money，几元钱就行了。
![](https://img-blog.csdnimg.cn/efae2ea6136d4e24b76d0c2906c50b47.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA57yW56iL5bCP55-z5aS0,size_20,color_FFFFFF,t_70,g_se,x_16)
然后就可以愉快的进行图像识别了。
![在这里插入图片描述](https://img-blog.csdnimg.cn/28707099e67a4cd299fdb3fa0830430d.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA57yW56iL5bCP55-z5aS0,size_20,color_FFFFFF,t_70,g_se,x_16)

# 九，图片识别核心代码
## 9-1，获取acess_token
我们后面做的所有操作，基本上都要获取这个。
![](https://img-blog.csdnimg.cn/e670c60f4e214e1d986b591b8ea42b24.png)
所以我把源码贴出来给到大家，client_id和client_secret记得换成你自己的。
```
wx.request({
      url: 'https://aip.baidubce.com/oauth/2.0/token',
      data: {
        grant_type: 'client_credentials',
        client_id:, //应用的API Key
        client_secret:  //应用的Secret Key
      },
      header: {
        'Content-Type': 'application/json' // 默认值
      },
      success: res => {
        this.setData({
          token: res.data.access_token //获取到token
        })
        console.log('获取到的token', this.data.token)
      }
    })
```

我们图片识别其实和上面的人脸识别操作步骤差不多的，依然也是先开通图片识别功能。
![](https://img-blog.csdnimg.cn/ac4f19a10d89497fa31e329993002972.png)
通过上图或者这个地址进入图片识别页面：https://cloud.baidu.com/doc/IMAGERECOGNITION/index.html
![](https://img-blog.csdnimg.cn/673e68bc57c0488c8f55de3abd3a767a.png)
## 9-2，图片识别核心文档
我们首先去看下官方文档 https://cloud.baidu.com/product/imagerecognition/general

![](https://img-blog.csdnimg.cn/f6df4b93d26f43d98865187983749d6a.png)

![](https://img-blog.csdnimg.cn/21af76b56a2b4677bfe498e1d97f4037.png)
我们这里使用通用物体和场景识别，这样可以识别很多东西

## 9-3，图片识别核心代码
我们做图片识别依然是先拍照，然后上传到百度进行图片识别
我先看下识别结果的格式如下：
![](https://img-blog.csdnimg.cn/ad450c31e1b04f8784073d28a85b5a9a.png)
我这里把代码全部贴出来给到大家
### wxml代码
```
<view style="width: 100%; height:calc(100vh - 200rpx);">
  <camera style="width: 100%; height:100%;" wx:if="{{isCamera}}" device-position="back" flash="off" binderror="error"></camera>
  <image style="width: 100%; height:100%;" wx:else mode="widthFix" src="{{src}}"></image>
</view>

<view class='photo-view'>
  <view class='takePhoto' bindtap="takePhoto">{{btnTxt}}</view>
</view>

<!-- 识别结果弹窗 -->
<view class="mask" hidden="{{!isShow}}" bindtap="hideModal"></view>
<view class="mask_content" hidden="{{!isShow}}">
  <view class="mask_title">识别结果如下</view>
  <block wx:for="{{results}}" wx:key="index">
    <view class="mask_item">{{item.keyword}}(点击查看)</view>
  </block>
</view>
```
### wxss代码
```
.photo-view {
  width: 100%;
  height: 200rpx;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

.takePhoto {
  width: 100rpx;
  height: 100rpx;
  border-radius: 100rpx;
  background-color: #00cc77;
  color: white;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

/* 识别出的结果 */
.mask {
  position: fixed;
  left: 0;
  right: 0;
  top: 0;
  bottom: 0;
  opacity: 0.5;
  background: black;
  /* 设置组件的层级 */
  z-index: 100;
}

.mask_content {
  position: fixed;
  left: 80rpx;
  top: 200rpx;
  right: 80rpx;
  height: 600rpx;
  background: white;
  z-index: 200;
  overflow: auto;
}

.mask_title {
  text-align: center;
  font-size: 50rpx;
  color: red;
  margin-bottom: 20rpx;
}

.mask_item {
  text-align: center;
  padding: 15rpx;
  border-bottom: 1px solid gainsboro;
}
```
### js代码
```
const app = getApp()
Page({
  data: {
    accessToken: "",
    isShow: false,
    results: [{
        keyword: "人物特写",
        score: 0.813571,
        root: "人物-人物特写"
      },
      {
        keyword: "男孩",
        score: 0.630612,
        root: "人物活动-人物特写"
      },
      {
        keyword: "女孩",
        score: 0.353866,
        root: "人物-人物特写"
      }
    ],
    src: "",
    isCamera: true,
    btnTxt: "拍照"
  },
  onLoad() {
    this.ctx = wx.createCameraContext()
    var time = wx.getStorageSync("time")
    var curTime = new Date().getTime()
    var timeInt = parseInt(time)
    var timeNum = parseInt((curTime - timeInt) / (1000 * 60 * 60 * 24))
    console.log("=======" + timeNum)
    var accessToken = wx.getStorageSync("access_token")
    console.log("====accessToken===" + accessToken + "a")
    // accessToken超过30天过期
    if (timeNum > 28 || (accessToken == "" ||
        accessToken == null || accessToken == undefined)) {
      this.accessTokenFunc()
    } else {
      this.setData({
        accessToken: wx.getStorageSync("access_token")
      })
    }
  },
  // 第一步，拍照
  takePhoto() {
    var that = this
    if (this.data.isCamera == false) {
      this.setData({
        isCamera: true,
        btnTxt: "拍照"
      })
      return
    }
    this.ctx.takePhoto({
      quality: 'high',
      success: (res) => {
        this.setData({
          src: res.tempImagePath,
          isCamera: false,
          btnTxt: "重拍"
        })
        wx.showLoading({
          title: '正在加载中',
        })
        wx.getFileSystemManager().readFile({
          filePath: res.tempImagePath,
          encoding: "base64",
          success: res => {
            that.shibie(res.data)
          },
          fail: res => {
            wx.hideLoading()
            wx.showToast({
              title: '拍照失败,未获取相机权限或其他原因',
              icon: "none"
            })
          }
        })
      }
    })
  },

  //第二步：上传图片进行识别
  shibie(image) {
    var that = this
    if (image == "") {
      wx.showToast({
        title: '请重试',
        icon: 'loading',
        duration: 500
      })
      return
    }

    if (image != "") {
      wx.request({
        url: 'https://aip.baidubce.com/rest/2.0/image-classify/v2/advanced_general',
        method: 'POST',
        data: {
          access_token: that.data.accessToken,
          image: image,
        },
        header: {
          'Content-Type': 'application/x-www-form-urlencoded' // 默认值
        },
        success(res) {
          wx.hideLoading()
          console.log("图片识别返回结果", res)
          // 如果access_token过期，就重新请求access_token
          let code = res.data.err_code
          if (code == 111 || code == 100 || code == 110) {
            wx.clearStorageSync("access_token")
            wx.clearStorageSync("time")
            that.accessTokenFunc()
            return
          }
          // 返回的识别结果
          let results = res.data.result
          if (results != undefined && results != null) {
            that.setData({
              isShow: true,
              results: results
            })
            console.log("识别到的结果", results)
          } else {
            wx.clearStorageSync("access_token")
            wx.showToast({
              icon: 'error',
              title: '识别失败,请重试',
            })
          }
        }
      });
    }

  },

  // 获取百度的AccessToken
  accessTokenFunc() {
    wx.request({
      url: 'https://aip.baidubce.com/oauth/2.0/token',
      data: {
        grant_type: 'client_credentials',
        client_id: app.globalData.client_id, //应用的API Key
        client_secret: app.globalData.client_secret //应用的Secret Key
      },
      header: {
        'Content-Type': 'application/json' // 默认值
      },
      success: res => {
        this.setData({
          accessToken: res.data.access_token //获取到token
        })
        console.log('获取到的token', this.data.accessToken)
        wx.setStorageSync("access_token", this.data.accessToken)
        wx.setStorageSync("time", new Date().getTime())
      },
      fail: res => {
        wx.clearStorageSync("access_token")
        wx.showToast({
          icon: 'error',
          title: '调用失败,请重新尝试',
        })
      }
    })
  },

  // 选择识别的结果
  radioChange: function (e) {
    console.log(e)
    console.log(e.detail)
    console.log(e.detail.value)
    wx.navigateTo({
      url: '/pages/result/list?keyword=' + e.detail.value,
    })
  },
  // 隐藏弹窗
  hideModal: function () {
    this.setData({
      isShow: false,
    })
  },


})
```

效果图如下：
![](https://img-blog.csdnimg.cn/ebd7f9b0198349278dc9883e86177ad3.png)
识别出来的结果如下：
![](https://img-blog.csdnimg.cn/f413d46505aa4103963caf8f062ee59e.png)
到这里我们图片识别的功能也做好了。欢迎关注编程小石头，后面会出更多更好的内容。

# 十，语音识别核心代码
## 10-1，获取acess_token
我们语音识别和图片识别公用一个acess_token，所以代码还是下面的这个。

所以我把源码贴出来给到大家，client_id和client_secret记得换成你自己的。
```
wx.request({
      url: 'https://aip.baidubce.com/oauth/2.0/token',
      data: {
        grant_type: 'client_credentials',
        client_id:, //应用的API Key
        client_secret:  //应用的Secret Key
      },
      header: {
        'Content-Type': 'application/json' // 默认值
      },
      success: res => {
        this.setData({
          token: res.data.access_token //获取到token
        })
        console.log('获取到的token', this.data.token)
      }
    })
```
## 10-2，语音识别核心文档
![](https://img-blog.csdnimg.cn/3b3d6e8c1c0c43eaaf72f1c9bfd9aba8.png)
https://cloud.baidu.com/doc/SPEECH/s/Ikhq0parc
![](https://img-blog.csdnimg.cn/d21b02d25c9c40b39f20d8fcd3ec04b3.png)
## 10-3，核心代码
### 10-3-1，wxml代码
```
<!-- 语音识别 -->
<view class='ai_root'>
    <image src='/image/speech.png' class='ai_img' 
    bindtouchstart='onTouchStart' bindtouchend='onTouchEnd' />
    <text class='ai_txt'>长按语音识别</text>
</view>
<view wx:if="{{canRecordStart}}" class="speak_style">
    <image wx:if="{{j==1}}" class="sound_style" src="/image/speech_1.png"></image>
    <image wx:if="{{j==2}}" class="sound_style" src="/image/speech_2.png"></image>
    <image wx:if="{{j==3}}" class="sound_style" src="/image/speech_3.png"></image>
    <image wx:if="{{j==4}}" class="sound_style" src="/image/speech_4.png"></image>
    <image wx:if="{{j==5}}" class="sound_style" src="/image/speech_5.png"></image>
</view>
```
### 10-3-2，js代码
```
/**
 * 作者：编程小石头
 * 微信：2501902696
 */
const app = getApp()

Page({

    isSpeaking: false,

    data: {
        canRecordStart: false,
        accessToken: "",
    },



    onLoad: function (options) {
        // 获取accessToken
        var time = wx.getStorageSync("time")
        var curTime = new Date().getTime()
        var timeInt = parseInt(time)
        var timeNum = parseInt((curTime - timeInt) / (1000 * 60 * 60 * 24))
        console.log("=======" + timeNum)
        let accessToken = wx.getStorageSync("access_token")
        console.log("====accessToken===" + accessToken)
        // accessToken超过30天过期
        if (timeNum > 28 || (accessToken == "" ||
                accessToken == null || accessToken == undefined)) {
            this.accessTokenFunc()
        } else {
            this.setData({
                accessToken: wx.getStorageSync("access_token")
            })
        }
    },
    // 获取百度的AccessToken
    accessTokenFunc() {
        wx.request({
            url: 'https://aip.baidubce.com/oauth/2.0/token',
            data: {
                grant_type: 'client_credentials',
                client_id: app.globalData.client_id, //应用的API Key
                client_secret: app.globalData.client_secret //应用的Secret Key
            },
            header: {
                'Content-Type': 'application/json' // 默认值
            },
            success: res => {
                this.setData({
                    accessToken: res.data.access_token //获取到token
                })
                console.log('获取到的token', this.data.accessToken)
                wx.setStorageSync("access_token", this.data.accessToken)
                wx.setStorageSync("time", new Date().getTime())
            },
            fail: res => {
                wx.clearStorageSync("access_token")
                wx.showToast({
                    icon: 'error',
                    title: '调用失败,请重新尝试',
                })
            }
        })
    },



    // 语音识别
    onTouchStart: function () {
        console.log('onTouchStart!' + this.data.canRecordStart);
        speaking.call(this);
        this.setData({
            canRecordStart: true
        });
        this.startRecord();
    },

    onTouchEnd: function () {
        console.log('onTouchEnd!canRecordStart:' +
            this.data.canRecordStart + '----isSpeaking:' + this.isSpeaking);
        clearInterval(this.timer);
        this.setData({
            canRecordStart: false
        });
        if (this.isSpeaking) {
            wx.getRecorderManager().stop();
        }

    },
    //开始录音的时候
    startRecord() {
        console.log('开始录音');
        const recorderManager = wx.getRecorderManager();
        const options = {
            duration: 30000, //指定录音的时长，单位 ms
            sampleRate: 16000, //采样率
            numberOfChannels: 1, //录音通道数
            encodeBitRate: 48000, //编码码率
            format: 'aac', //音频格式，有效值 aac/mp3
        };

        console.log('开始正式录音前，canRecordStart：' + this.data.canRecordStart);
        //开始录音
        if (this.data.canRecordStart) {
            recorderManager.start(options);
            this.isSpeaking = true;
        }
        recorderManager.onStart(() => {
            console.log('recorder start')

        });


        recorderManager.onPause(() => {
            console.log('recorder pause')
        })
        recorderManager.onStop((res) => {
            this.isSpeaking = false;
            console.log('recorder stop', res);
            //wx.hideLoading();
            if (res && res.duration < 600) {
                wx.showToast({
                    title: '说话时间太短啦！',
                    icon: 'error'

                })
                return;
            }
            if (res && res.duration > 8000) {
                wx.showToast({
                    title: '说的有点长，可以精简点呀~',
                    icon: 'error'
                })
                return;
            }
            const {
                tempFilePath
            } = res
            this.speechRecognition(res);
        })


        //错误回调
        recorderManager.onError((res) => {
            // console.log('录音错误回调：' + JSON.stringify(res));
            wx.showModal({
                title: '请打开录音权限',
                success: res => {
                    if (res.confirm) {
                        wx.openSetting({
                            withSubscriptions: true,
                        })
                    }
                }
            })
        })
    },


    // 识别语音
    speechRecognition: function (res) {
        wx.showLoading({
            title: '识别中...',
        })
        var that = this;
        var fileSize = res.fileSize;
        var tempFilePath = res.tempFilePath;
        var format = 'pcm';
        if (tempFilePath) {
            format = tempFilePath.substring(tempFilePath.lastIndexOf('.') + 1);
        }
        const fileSystemManager = wx.getFileSystemManager()
        fileSystemManager.readFile({
            filePath: res.tempFilePath,
            encoding: "base64",
            success(res) {
                // console.log(res);
                var base64 = res.data;
                var data = {
                    "format": format,
                    "rate": 16000,
                    "dev_pid": 80001,
                    "channel": 1,
                    "token": that.data.accessToken,
                    "cuid": "baidu_workshop",
                    "len": fileSize,
                    "speech": base64
                }

                // console.log('语音识别请求参数：' + JSON.stringify(data));
                wx.request({
                    url: 'https://vop.baidu.com/pro_api',
                    method: 'post',
                    data: data,
                    success(res) {
                        wx.hideLoading();
                        console.log("========================语音识别结果", res.data)
                        var result = res.data.result;
                        if (result && result.length > 0) {
                            var location = result[0].lastIndexOf("。");
                            // var location = result[0].lastIndexOf("");
                            var text = '';
                            console.log(result[0]);
                            console.log('符号位置：' + location);

                            text = result[0].replace(/[\ |\~|\`|\!|\@|\#|\$|\%|\^|\&|\*|\(|\)|\-|\_|\+|\=|\||\\|\[|\]|\{|\}|\;|\:|\"|\'|\,|\<|\.|\。|\，|\！|\；|\>|\/|\?]/g, "")
                            console.log('识别出来的文字' + text);
                            if (location && location > 0) {
                                text = text.substr(0, location)
                                console.log('去除末尾句号' + text);
                            }

                            wx.showModal({
                                title: '识别结果',
                                content: '识别结果是《' + text + "》点击确定去搜索页查看属于哪类垃圾",
                                success: res => {
                                    if (res.confirm) {
                                        wx.navigateTo({
                                            url: '/pages/search/search?searchKey=' + text + '&type=0',
                                        })
                                    }
                                }
                            })

                        } else {
                            //没有result，认为语音识别失败
                            wx.showModal({
                                title: '提示',
                                content: '不知道你说的啥，可以再试试~',
                                showCancel: false,
                                success(res) {
                                    if (res.confirm) {
                                        console.log('用户点击确定')
                                    } else if (res.cancel) {
                                        console.log('用户点击取消')
                                    }
                                }
                            })

                        }


                    },
                    fail(error) {
                        wx.hideLoading();
                        console.log("====================语音识别失败", error);
                        wx.showToast({
                            icon: 'none',
                            title: '请求失败了，请确保网络正常，重新试试~',
                        })
                    }

                })

            },
            fail(res) {
                wx.hideLoading();
                console.log(res)
            }
        })

    },
})
//麦克风帧动画
function speaking() {
    var _this = this;
    //话筒帧动画
    var i = 1;
    this.timer = setInterval(function () {
        i++;
        i = i % 5;
        _this.setData({
            j: i
        })
    }, 200);
}
```
### 10-3-3，wxss代码
```
.ai_root {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: 50rpx;
}

.ai_img {
    width: 250rpx;
    height: 250rpx;
    margin-top: 150rpx;
}

.ai_txt {
    font-size: 44rpx;
    font-weight: bold;
    color: #00cc77;
    margin-top: 30rpx;
}



/* 语音识别动画 */
.speak_style {
    position: fixed;
    top: 250rpx;
    right: 20rpx;
    z-index: 999;
    justify-content: flex-end;
    align-items: flex-end;
    flex-direction: column;


}

.sound_style {
    width: 128rpx;
    height: 128rpx;
}
```

效果图如下：
![](https://img-blog.csdnimg.cn/959ca79934ad44569a93a0f65ab5dc71.png)
点击去搜索：
![](https://img-blog.csdnimg.cn/72dfcd2f06794922bf40c3cf3facb016.png)

到这里我们核心功能就基本上讲的差不多了